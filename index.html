<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Fichaje Obras â€“ BRB Construcciones</title>

  <!-- Vista correcta en mÃ³vil / tablet -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#16a34a" />

  <!-- Leaflet CSS para el mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    :root {
      --bg-body: #0f172a;
      --bg-gradient: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      --card-bg: #0b1120;
      --card-border: #1e293b;
      --accent: #16a34a; /* verde principal */
      --accent-soft: rgba(22, 163, 74, 0.15);
      --accent-strong: #15803d;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --chip-bg: #111827;
      --danger-bg: #7f1d1d;
      --danger-soft: #fef2f2;
      --danger-text: #fecaca;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-body);
      background-image: var(--bg-gradient);
      color: var(--text-main);
    }

    h1 {
      margin-top: 0;
      margin-bottom: 1.25rem;
      font-size: 2rem;
      text-align: center;
      letter-spacing: 0.03em;
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 0.75rem;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: linear-gradient(145deg, #020617, #020617, #020617, #020617);
      border-radius: 20px;
      padding: 1.1rem 1.3rem;
      margin-bottom: 1.2rem;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
      border: 1px solid var(--card-border);
      border-left-width: 6px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.35rem;
    }

    .card-header-title {
      font-weight: 700;
      font-size: 1.15rem;
    }

    .title-box {
      padding: 0.6rem 0.9rem;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.85);
      min-width: 0;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease, background 0.1s ease;
    }

    .title-box:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.75);
      border-color: rgba(148, 163, 184, 1);
      background: rgba(15, 23, 42, 0.95);
    }

    .title-box .small-text {
      margin-top: 0.2rem;
    }

    .obra-header-right {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      align-items: flex-end;
      font-size: 0.85rem;
    }

    .small-text {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
      color: var(--text-muted);
    }

    input[type="text"] {
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 12px;
      border: 1px solid #1f2937;
      font-size: 0.95rem;
      outline: none;
      background: #020617;
      color: var(--text-main);
    }

    input[type="text"]::placeholder {
      color: #6b7280;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
      background: #020617;
    }

    select {
      padding: 0.5rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 0.9rem;
      background: #020617;
      color: var(--text-main);
      cursor: pointer;
    }

    button {
      padding: 0.55rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, filter 0.08s ease;
      white-space: nowrap;
    }

    button.primary {
      background: var(--accent);
      color: #ecfdf5;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(22, 163, 74, 0.55);
    }

    button.primary:hover {
      background: var(--accent-strong);
      box-shadow: 0 12px 32px rgba(22, 163, 74, 0.65);
    }

    button.primary:active {
      transform: scale(0.97);
      filter: brightness(0.95);
      box-shadow: 0 7px 18px rgba(22, 163, 74, 0.6);
    }

    button.secondary {
      background: #020617;
      color: var(--text-main);
      border: 1px solid #1f2937;
    }

    button.secondary:hover {
      background: #020617;
      border-color: #374151;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.6);
    }

    button.secondary:active {
      transform: scale(0.97);
      filter: brightness(0.96);
    }

    button.danger {
      background: #111827;
      color: var(--danger-text);
      border-color: #7f1d1d;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.9rem;
      margin-bottom: 0.9rem;
    }

    .obra-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      font-size: 0.85rem;
    }

    .chip {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      background: var(--chip-bg);
      font-size: 0.8rem;
      border: 1px solid #1f2937;
    }

    .empresa-chip {
      font-weight: 500;
      color: #e5e7eb;
    }

    .workers-list {
      margin-top: 0.6rem;
      border-top: 1px dashed #1f2937;
      padding-top: 0.6rem;
    }

    .worker-item {
      padding: 0.5rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      border-bottom: 1px dashed #111827;
    }

    .worker-main {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
    }

    .worker-info {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      font-size: 0.9rem;
    }

    .worker-name {
      font-weight: 500;
    }

    .worker-dni {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .worker-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      justify-content: flex-end;
    }

    .check {
      font-size: 0.85rem;
      opacity: 0;
      transition: opacity 0.2s ease;
      color: #4ade80;
    }

    .check.visible {
      opacity: 1;
    }

    .history {
      margin-top: 0.3rem;
      padding: 0.45rem 0.7rem;
      border-radius: 12px;
      background: #020617;
      font-size: 0.8rem;
      display: none;
      border: 1px dashed #1f2937;
    }

    .history.visible {
      display: block;
    }

    .history ul {
      padding-left: 1.2rem;
      margin: 0.3rem 0 0;
    }

    .history li {
      margin-bottom: 0.15rem;
    }

    .empty-text {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .obra-details {
      margin-top: 0.6rem;
      display: none;
    }

    .obra-details.visible {
      display: block;
    }

    #obraMap {
      height: 260px;
      border-radius: 14px;
      margin-top: 0.5rem;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    /* ðŸ”¹ Estilos RESPONSIVE para mÃ³vil / tablet */
    @media (max-width: 900px) {
      body {
        padding: 0.75rem;
      }

      h1 {
        font-size: 1.6rem;
        margin-bottom: 1rem;
      }

      .card {
        border-radius: 18px;
        padding: 0.9rem 1rem;
        box-shadow: 0 14px 35px rgba(0, 0, 0, 0.9);
      }

      .card-header {
        flex-direction: column;
        align-items: stretch;
      }

      .obra-header-right {
        align-items: flex-start;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      input[type="text"] {
        padding: 0.7rem 0.85rem;
        font-size: 1rem;
      }

      select {
        padding: 0.6rem 0.9rem;
        font-size: 0.95rem;
      }

      button {
        padding: 0.75rem 1rem;
        font-size: 1rem;
      }

      .worker-main {
        flex-direction: column;
        align-items: stretch;
      }

      .worker-actions {
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
      }

      .worker-actions button {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 500px) {
      body {
        padding: 0.5rem;
      }

      h1 {
        font-size: 1.45rem;
      }

      .card {
        border-radius: 0.75rem;
        padding: 0.8rem 0.85rem;
      }

      #obraMap {
        height: 220px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <h1>Fichaje de obras â€“ BRB Construcciones</h1>

    <!-- Formulario para aÃ±adir obra -->
    <div class="card">
      <h2>Nueva obra</h2>
      <div class="form-row">
        <div>
          <label for="obraTitulo">TÃ­tulo de la obra</label>
          <input type="text" id="obraTitulo" placeholder="Reforma edificio Calle Mayor 12" />
        </div>
        <div>
          <label for="obraLugar">Lugar (descripciÃ³n)</label>
          <input type="text" id="obraLugar" placeholder="Las Palmas de Gran Canaria" />
        </div>
      </div>

      <div class="obra-meta" style="margin-bottom:0.75rem;">
        <span class="chip empresa-chip">Empresa: BRB Construcciones</span>
        <div>
          <label for="obraTipoEmpresa">Tipo de empresa</label>
          <select id="obraTipoEmpresa">
            <option value="SL">SL</option>
            <option value="AutÃ³nomo">AutÃ³nomo</option>
          </select>
        </div>
      </div>

      <div style="margin-top:0.75rem;">
        <label>Selecciona la ubicaciÃ³n en el mapa (opcional)</label>
        <div id="obraMap"></div>
        <p id="obraCoordsText" class="small-text" style="margin-top:0.3rem;">
          Sin coordenadas seleccionadas.
        </p>
      </div>

      <button id="btnAddObra" class="primary" style="margin-top:0.9rem;">AÃ±adir obra</button>
      <p id="obraError" class="small-text" style="color:#f97373; margin-top:0.5rem; display:none;">
        Rellena al menos el tÃ­tulo y el lugar.
      </p>
    </div>

    <!-- Listado de obras -->
    <div id="obrasContainer"></div>
  </div>

  <!-- Leaflet JS para el mapa -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- APP + FIREBASE en un script tipo mÃ³dulo -->
  <script type="module">
    // Firebase modular desde CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // ðŸ”¥ Config de TU proyecto
    const firebaseConfig = {
      apiKey: "AIzaSyBCoaW8FFNghoXmCuoyZJSHWLEFN5mlJJU",
      authDomain: "fichaje-brb-c9385.firebaseapp.com",
      projectId: "fichaje-brb-c9385",
      storageBucket: "fichaje-brb-c9385.firebasestorage.app",
      messagingSenderId: "695373590746",
      appId: "1:695373590746:web:8dd206b125b3119c7cf5e3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "app", "data"); // DOC ÃšNICO

    const state = { obras: [] };

    const obraColors = [
      "#22c55e",
      "#38bdf8",
      "#a855f7",
      "#facc15",
      "#f97316",
      "#ec4899"
    ];

    let obraMap = null;
    let obraMarker = null;
    let newObraCoords = null;

    function createId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    async function saveToCloud() {
      await setDoc(dataDocRef, { obras: state.obras });
    }

    function setupMap() {
      const mapContainer = document.getElementById("obraMap");
      if (!mapContainer) return;

      obraMap = L.map("obraMap").setView([27.919, -15.409], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(obraMap);

      const coordsText = document.getElementById("obraCoordsText");

      obraMap.on("click", (e) => {
        newObraCoords = e.latlng;

        if (obraMarker) {
          obraMarker.setLatLng(e.latlng);
        } else {
          obraMarker = L.marker(e.latlng).addTo(obraMap);
        }

        coordsText.textContent =
          "Coordenadas seleccionadas: " +
          e.latlng.lat.toFixed(5) +
          ", " +
          e.latlng.lng.toFixed(5);
      });
    }

    function setupAddObraForm() {
      const tituloInput = document.getElementById("obraTitulo");
      const lugarInput = document.getElementById("obraLugar");
      const tipoSelect = document.getElementById("obraTipoEmpresa");
      const addButton = document.getElementById("btnAddObra");
      const errorMsg = document.getElementById("obraError");
      const coordsText = document.getElementById("obraCoordsText");

      addButton.addEventListener("click", async () => {
        const titulo = tituloInput.value.trim();
        const lugar = lugarInput.value.trim();
        const tipo = tipoSelect.value;

        if (!titulo || !lugar) {
          errorMsg.style.display = "block";
          return;
        }
        errorMsg.style.display = "none";

        const nuevaObra = {
          id: createId(),
          titulo,
          lugar,
          empresaNombre: "BRB Construcciones",
          empresaTipo: tipo,
          trabajadores: [],
          expanded: false,
          coords: newObraCoords
            ? { lat: newObraCoords.lat, lng: newObraCoords.lng }
            : null
        };

        state.obras.push(nuevaObra);
        await saveToCloud();

        tituloInput.value = "";
        lugarInput.value = "";
        tipoSelect.value = "SL";

        newObraCoords = null;
        if (obraMarker && obraMap) {
          obraMap.removeLayer(obraMarker);
          obraMarker = null;
        }
        coordsText.textContent = "Sin coordenadas seleccionadas.";
      });
    }

    function renderObras() {
      const container = document.getElementById("obrasContainer");
      container.innerHTML = "";

      if (state.obras.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-text";
        p.textContent = "TodavÃ­a no hay obras creadas.";
        container.appendChild(p);
        return;
      }

      state.obras.forEach((obra, index) => {
        const card = document.createElement("div");
        card.className = "card";

        const color = obraColors[index % obraColors.length];
        card.style.borderLeftColor = color;

        const header = document.createElement("div");
        header.className = "card-header";

        const titleBox = document.createElement("div");
        titleBox.className = "title-box";
        titleBox.style.borderColor = color;

        const title = document.createElement("div");
        title.className = "card-header-title";
        title.textContent = obra.titulo;

        const subtitle = document.createElement("div");
        subtitle.className = "small-text";
        subtitle.textContent = obra.lugar;

        if (obra.coords) {
          const coordsLine = document.createElement("div");
          coordsLine.className = "small-text";
          coordsLine.textContent =
            "Coordenadas: " +
            obra.coords.lat.toFixed(5) +
            ", " +
            obra.coords.lng.toFixed(5);
          subtitle.appendChild(document.createElement("br"));
          subtitle.appendChild(coordsLine);
        }

        titleBox.appendChild(title);
        titleBox.appendChild(subtitle);

        const empresaDiv = document.createElement("div");
        empresaDiv.className = "small-text";
        empresaDiv.innerHTML =
          "<strong>" +
          obra.empresaNombre +
          "</strong> Â· " +
          obra.empresaTipo;

        const deleteObraBtn = document.createElement("button");
        deleteObraBtn.className = "secondary danger";
        deleteObraBtn.textContent = "Eliminar obra";

        deleteObraBtn.addEventListener("click", async () => {
          const seguro = confirm(
            "Â¿Seguro que quieres eliminar esta obra y todos sus trabajadores y fichajes?"
          );
          if (!seguro) return;

          state.obras = state.obras.filter((o) => o.id !== obra.id);
          await saveToCloud();
        });

        const rightSide = document.createElement("div");
        rightSide.className = "obra-header-right";
        rightSide.appendChild(empresaDiv);
        rightSide.appendChild(deleteObraBtn);

        header.appendChild(titleBox);
        header.appendChild(rightSide);

        card.appendChild(header);

        const details = document.createElement("div");
        details.className = "obra-details";
        if (obra.expanded) {
          details.classList.add("visible");
        }

        const formTrab = document.createElement("div");
        formTrab.className = "form-row";

        const nombreWrapper = document.createElement("div");
        const nombreLabel = document.createElement("label");
        nombreLabel.textContent = "Nombre";
        const nombreInput = document.createElement("input");
        nombreInput.type = "text";
        nombreInput.placeholder = "Nombre";
        nombreWrapper.appendChild(nombreLabel);
        nombreWrapper.appendChild(nombreInput);

        const apellidosWrapper = document.createElement("div");
        const apellidosLabel = document.createElement("label");
        apellidosLabel.textContent = "Apellidos";
        const apellidosInput = document.createElement("input");
        apellidosInput.type = "text";
        apellidosInput.placeholder = "Apellidos";
        apellidosWrapper.appendChild(apellidosLabel);
        apellidosWrapper.appendChild(apellidosInput);

        const dniWrapper = document.createElement("div");
        const dniLabel = document.createElement("label");
        dniLabel.textContent = "DNI";
        const dniInput = document.createElement("input");
        dniInput.type = "text";
        dniInput.placeholder = "00000000X";
        dniWrapper.appendChild(dniLabel);
        dniWrapper.appendChild(dniInput);

        formTrab.appendChild(nombreWrapper);
        formTrab.appendChild(apellidosWrapper);
        formTrab.appendChild(dniWrapper);

        const addTrabBtn = document.createElement("button");
        addTrabBtn.textContent = "AÃ±adir trabajador";
        addTrabBtn.className = "secondary";

        const errorTrab = document.createElement("p");
        errorTrab.className = "small-text";
        errorTrab.style.color = "#f97373";
        errorTrab.style.display = "none";
        errorTrab.style.marginTop = "0.3rem";
        errorTrab.textContent =
          "Nombre, apellidos y DNI son obligatorios.";

        const workersContainer = document.createElement("div");
        workersContainer.className = "workers-list";

        if (!Array.isArray(obra.trabajadores)) {
          obra.trabajadores = [];
        }

        if (obra.trabajadores.length === 0) {
          const empty = document.createElement("p");
          empty.className = "empty-text";
          empty.textContent = "No hay trabajadores aÃ±adidos aÃºn.";
          workersContainer.appendChild(empty);
        } else {
          obra.trabajadores.forEach((trabajador) => {
            const workerEl = createWorkerElement(obra, trabajador);
            workersContainer.appendChild(workerEl);
          });
        }

        details.appendChild(formTrab);
        details.appendChild(addTrabBtn);
        details.appendChild(errorTrab);
        details.appendChild(workersContainer);

        card.appendChild(details);

        addTrabBtn.addEventListener("click", async () => {
          const nombre = nombreInput.value.trim();
          const apellidos = apellidosInput.value.trim();
          const dni = dniInput.value.trim();

          if (!nombre || !apellidos || !dni) {
            errorTrab.style.display = "block";
            return;
          }
          errorTrab.style.display = "none";

          const nuevoTrab = {
            id: createId(),
            nombre,
            apellidos,
            dni,
            fichajes: []
          };

          const emptyMsg = workersContainer.querySelector(".empty-text");
          if (emptyMsg) {
            workersContainer.removeChild(emptyMsg);
          }

          obra.trabajadores.push(nuevoTrab);
          await saveToCloud();
        });

        titleBox.addEventListener("click", async () => {
          const wasExpanded = !!obra.expanded;
          state.obras.forEach((o) => {
            o.expanded = false;
          });
          obra.expanded = !wasExpanded;
          await saveToCloud();
        });

        container.appendChild(card);
      });
    }

    function createWorkerElement(obra, trabajador) {
      const workerItem = document.createElement("div");
      workerItem.className = "worker-item";

      const main = document.createElement("div");
      main.className = "worker-main";

      const info = document.createElement("div");
      info.className = "worker-info";

      const name = document.createElement("div");
      name.className = "worker-name";
      name.textContent = trabajador.nombre + " " + trabajador.apellidos;

      const dni = document.createElement("div");
      dni.className = "worker-dni";
      dni.textContent = "DNI: " + trabajador.dni;

      info.appendChild(name);
      info.appendChild(dni);

      const actions = document.createElement("div");
      actions.className = "worker-actions";

      const ficharBtn = document.createElement("button");
      ficharBtn.className = "primary";
      ficharBtn.textContent = "Fichar";

      const exportBtn = document.createElement("button");
      exportBtn.className = "secondary";
      exportBtn.textContent = "Exportar historial (Word)";

      const historyToggle = document.createElement("button");
      historyToggle.className = "secondary";
      historyToggle.textContent = "Ver historial";

      const deleteWorkerBtn = document.createElement("button");
      deleteWorkerBtn.className = "secondary danger";
      deleteWorkerBtn.textContent = "Eliminar trabajador";

      actions.appendChild(ficharBtn);
      actions.appendChild(exportBtn);
      actions.appendChild(historyToggle);
      actions.appendChild(deleteWorkerBtn);

      main.appendChild(info);
      main.appendChild(actions);

      workerItem.appendChild(main);

      const history = document.createElement("div");
      history.className = "history";
      workerItem.appendChild(history);

      function renderHistory() {
        history.innerHTML = "";
        const title = document.createElement("div");
        title.textContent = "Historial de fichajes:";
        history.appendChild(title);

        if (!Array.isArray(trabajador.fichajes) || trabajador.fichajes.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty-text";
          empty.textContent = "Este trabajador aÃºn no ha fichado.";
          history.appendChild(empty);
          return;
        }

        const list = document.createElement("ul");
        const sorted = trabajador.fichajes
          .slice()
          .sort((a, b) => b - a);

        sorted.forEach((ts, idx) => {
          const li = document.createElement("li");
          const fecha = new Date(ts);
          li.textContent =
            (idx + 1) + ". " + fecha.toLocaleString("es-ES");
          list.appendChild(li);
        });

        history.appendChild(list);
      }

      renderHistory();

      ficharBtn.addEventListener("click", async () => {
        const now = Date.now();
        if (!Array.isArray(trabajador.fichajes)) {
          trabajador.fichajes = [];
        }
        trabajador.fichajes.push(now);

        await saveToCloud();

        if (history.classList.contains("visible")) {
          renderHistory();
        }
      });

      historyToggle.addEventListener("click", () => {
        const visible = history.classList.toggle("visible");
        if (visible) {
          renderHistory();
          historyToggle.textContent = "Ocultar historial";
        } else {
          historyToggle.textContent = "Ver historial";
        }
      });

      deleteWorkerBtn.addEventListener("click", async () => {
        const seguro = confirm(
          "Â¿Eliminar al trabajador " +
            trabajador.nombre +
            " " +
            trabajador.apellidos +
            " y todos sus fichajes?"
        );
        if (!seguro) return;

        obra.trabajadores = obra.trabajadores.filter(
          (t) => t.id !== trabajador.id
        );
        await saveToCloud();
      });

      exportBtn.addEventListener("click", () => {
        if (!Array.isArray(trabajador.fichajes) || trabajador.fichajes.length === 0) {
          alert("Este trabajador aÃºn no tiene fichajes para exportar.");
          return;
        }

        const sorted = trabajador.fichajes
          .slice()
          .sort((a, b) => a - b);

        let rows = "";
        sorted.forEach((ts, index) => {
          const fecha = new Date(ts).toLocaleString("es-ES");
          rows +=
            "<tr><td>" +
            (index + 1) +
            "</td><td>" +
            fecha +
            "</td></tr>";
        });

        const html =
          "<html><head><meta charset='utf-8'><title>Historial de fichajes</title></head><body>" +
          "<h2>Historial de fichajes</h2>" +
          "<p><b>Obra:</b> " +
          obra.titulo +
          " (" +
          obra.lugar +
          ")</p>" +
          "<p><b>Empresa:</b> " +
          obra.empresaNombre +
          " Â· " +
          obra.empresaTipo +
          "</p>" +
          "<p><b>Trabajador:</b> " +
          trabajador.nombre +
          " " +
          trabajador.apellidos +
          "</p>" +
          "<p><b>DNI:</b> " +
          trabajador.dni +
          "</p><br/>" +
          "<table border='1' cellpadding='4' cellspacing='0'>" +
          "<tr><th>#</th><th>Fecha y hora de fichaje</th></tr>" +
          rows +
          "</table></body></html>";

        const blob = new Blob(["\ufeff", html], {
          type: "application/msword"
        });
        const url = URL.createObjectURL(blob);

        const apellidoLimpio = trabajador.apellidos.replace(/\s+/g, "_");
        const nombreLimpio = trabajador.nombre.replace(/\s+/g, "_");
        const a = document.createElement("a");
        a.href = url;
        a.download = "historial_" + apellidoLimpio + "_" + nombreLimpio + ".doc";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      return workerItem;
    }

    function subscribeToCloud() {
      onSnapshot(
        dataDocRef,
        async (snap) => {
          if (!snap.exists()) {
            await setDoc(dataDocRef, { obras: [] });
            return;
          }
          const data = snap.data() || {};
          state.obras = Array.isArray(data.obras) ? data.obras : [];
          renderObras();
        },
        (err) => {
          console.error("Error escuchando Firestore:", err);
          alert("Error escuchando datos de la nube: " + err.message);
        }
      );
    }

    window.addEventListener("DOMContentLoaded", () => {
      setupAddObraForm();
      setupMap();
      subscribeToCloud();
    });
  </script>

  <!-- Registro del Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .then(() => console.log("Service Worker registrado"))
          .catch((err) => console.error("Error registrando Service Worker", err));
      });
    }
  </script>
</body>
</html>
