<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Fichaje Obras â€“ BRB Construcciones</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#007aff" />

  <!-- Leaflet CSS para el mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 1.5rem;
      font-family: system-ui;
      background: #f5f5f7;
      color: #222;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.8rem;
    }

    h2 { font-size: 1.2rem; }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      border-left: 6px solid #007aff33;
    }

    button {
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    button.primary { background: #007aff; color: white; }
    button.secondary { background: #dcdcdc; }
    button.danger { background: #ffcccc; color: red; }

    /* ðŸ”¥ CHECK ANIMADO */
    .check {
      opacity: 0;
      background: #2ecc71;
      color: white;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: bold;
      margin-left: 8px;
      transition: opacity 0.25s ease-in-out;
      font-size: 14px;
    }

    .check.visible {
      opacity: 1;
    }

  </style>
</head>
<body>
  <div class="layout">
    <h1>Fichaje de obras â€“ BRB Construcciones</h1>

    <!-- FORMulario de nueva obra -->
    <div class="card">
      <h2>Nueva obra</h2>

      <input id="obraTitulo" type="text" placeholder="TÃ­tulo" />
      <br /><br />
      <input id="obraLugar" type="text" placeholder="Lugar" />
      <br /><br />

      <select id="obraTipoEmpresa">
        <option value="SL">SL</option>
        <option value="AutÃ³nomo">AutÃ³nomo</option>
      </select>
      <br /><br />

      <button id="btnAddObra" class="primary">AÃ±adir obra</button>
    </div>

    <div id="obrasContainer"></div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // TU CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBCoaW8FFNghoXmCuoyZJSHWLEFN5mlJJU",
      authDomain: "fichaje-brb-c9385.firebaseapp.com",
      projectId: "fichaje-brb-c9385",
      storageBucket: "fichaje-brb-c9385.firebasestorage.app",
      messagingSenderId: "695373590746",
      appId: "1:695373590746:web:8dd206b125b3119c7cf5e3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const dataDocRef = doc(db, "app", "data");

    const state = { obras: [] };

    function createId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    async function saveToCloud() {
      await setDoc(dataDocRef, { obras: state.obras });
    }

    document.getElementById("btnAddObra").onclick = async () => {
      const titulo = document.getElementById("obraTitulo").value.trim();
      const lugar = document.getElementById("obraLugar").value.trim();
      const tipo = document.getElementById("obraTipoEmpresa").value;

      if (!titulo || !lugar) {
        alert("Rellena tÃ­tulo y lugar");
        return;
      }

      state.obras.push({
        id: createId(),
        titulo,
        lugar,
        empresaNombre: "BRB Construcciones",
        empresaTipo: tipo,
        trabajadores: [],
        expanded: true
      });

      await saveToCloud();
    };

    function renderObras() {
      const container = document.getElementById("obrasContainer");
      container.innerHTML = "";

      state.obras.forEach((obra) => {
        const card = document.createElement("div");
        card.className = "card";

        const title = document.createElement("h3");
        title.textContent = obra.titulo;

        const lugar = document.createElement("div");
        lugar.textContent = obra.lugar;

        const empresa = document.createElement("div");
        empresa.textContent =
          obra.empresaNombre + " Â· " + obra.empresaTipo;

        // aÃ±adir trabajador
        const nombre = document.createElement("input");
        nombre.placeholder = "Nombre";

        const apellidos = document.createElement("input");
        apellidos.placeholder = "Apellidos";

        const dni = document.createElement("input");
        dni.placeholder = "DNI";

        const btnAddTrab = document.createElement("button");
        btnAddTrab.textContent = "AÃ±adir trabajador";
        btnAddTrab.className = "secondary";

        const listaTrab = document.createElement("div");

        btnAddTrab.onclick = async () => {
          if (!nombre.value.trim() || !apellidos.value.trim() || !dni.value.trim()) {
            alert("Rellena todos los campos");
            return;
          }

          obra.trabajadores.push({
            id: createId(),
            nombre: nombre.value.trim(),
            apellidos: apellidos.value.trim(),
            dni: dni.value.trim(),
            fichajes: []
          });

          await saveToCloud();
        };

        // Renderizar trabajadores
        obra.trabajadores.forEach((trab) => {
          const fila = document.createElement("div");
          fila.style.marginTop = "10px";

          fila.textContent =
            trab.nombre + " " + trab.apellidos + " (" + trab.dni + ") ";

          // BotÃ³n de fichar
          const btnFichar = document.createElement("button");
          btnFichar.textContent = "Fichar";
          btnFichar.className = "primary";

          // âœ” CHECK VISUAL
          const check = document.createElement("span");
          check.className = "check";
          check.textContent = "âœ“ Fichado";

          btnFichar.onclick = async () => {
            trab.fichajes.push(Date.now());
            await saveToCloud();

            check.classList.add("visible");
            setTimeout(() => check.classList.remove("visible"), 2000);
          };

          fila.appendChild(btnFichar);
          fila.appendChild(check);
          listaTrab.appendChild(fila);
        });

        card.appendChild(title);
        card.appendChild(lugar);
        card.appendChild(empresa);
        card.appendChild(nombre);
        card.appendChild(apellidos);
        card.appendChild(dni);
        card.appendChild(btnAddTrab);
        card.appendChild(listaTrab);

        container.appendChild(card);
      });
    }

    onSnapshot(dataDocRef, (snap) => {
      if (!snap.exists()) {
        setDoc(dataDocRef, { obras: [] });
        return;
      }
      state.obras = snap.data().obras || [];
      renderObras();
    });
  </script>

  <!-- SERVICE WORKER -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>

</body>
</html>
