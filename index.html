<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Fichaje Obras ‚Äì BRB Construcciones</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#007aff" />

  <!-- Leaflet CSS para el mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * {
      box-sizing: border-box;
    }

    :root {
      --color-primary: #22c55e;      /* verde principal */
      --color-primary-dark: #16a34a; /* verde al pulsar */
      --color-bg: #f3f4f6;
      --color-card: #ffffff;
      --color-border: #e5e7eb;
      --color-text: #111827;
      --radius-card: 18px;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 1.25rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 42%, #f3f4f6 100%);
      color: var(--color-text);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    header.app-header {
      margin-bottom: 1.25rem;
    }

    header.app-header h1 {
      margin: 0 0 0.35rem;
      font-size: 1.9rem;
      font-weight: 800;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    header.app-header h1 span.logo-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 700;
    }

    header.app-header p {
      margin: 0;
      font-size: 0.9rem;
      color: #6b7280;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.6fr);
      gap: 1.25rem;
      align-items: flex-start;
    }

    .card {
      background: var(--color-card);
      border-radius: var(--radius-card);
      padding: 1rem 1.1rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.8rem;
      gap: 0.5rem;
    }

    .card-title h2 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card-title h2::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--color-primary);
    }

    .card-title span {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
      color: #4b5563;
      font-weight: 500;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.6rem 0.8rem;
      border-radius: 11px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.05s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--color-primary);
      background: #ffffff;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.18);
      transform: translateY(-0.5px);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .obra-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .chip {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      font-size: 0.8rem;
      color: #166534;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .chip::before {
      content: "‚óè";
      font-size: 0.55rem;
    }

    .small-text {
      font-size: 0.82rem;
      color: #6b7280;
    }

    button {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      transition: transform 0.07s ease, box-shadow 0.12s ease, background 0.12s ease, color 0.12s ease;
      font-weight: 500;
    }

    button.primary {
      background: var(--color-primary);
      color: #ffffff;
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.35);
    }

    button.primary:hover {
      background: var(--color-primary-dark);
      box-shadow: 0 10px 18px rgba(22, 163, 74, 0.45);
      transform: translateY(-1px);
    }

    button.primary:active {
      transform: translateY(0);
      background: var(--color-primary-dark);
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.45);
    }

    button.secondary {
      background: #eef2ff;
      color: #4338ca;
      box-shadow: 0 4px 10px rgba(129, 140, 248, 0.25);
    }

    button.secondary:hover {
      background: #e0e7ff;
      transform: translateY(-1px);
    }

    button.danger {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
      box-shadow: none;
    }

    button.danger:hover {
      background: #fee2e2;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    #btnAddObra {
      width: 100%;
      margin-top: 0.5rem;
    }

    .workers-list {
      margin-top: 0.65rem;
      border-top: 1px dashed #e5e7eb;
      padding-top: 0.55rem;
    }

    .worker-item {
      padding: 0.6rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      border-bottom: 1px dashed #e5e7eb;
    }

    .worker-main {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
    }

    .worker-info {
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
      font-size: 0.92rem;
    }

    .worker-name {
      font-weight: 600;
    }

    .worker-dni {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .worker-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      justify-content: flex-end;
    }

    .history {
      margin-top: 0.25rem;
      padding: 0.4rem 0.6rem;
      border-radius: 12px;
      background: #f3f4ff;
      font-size: 0.8rem;
      display: none;
      border: 1px dashed #c7d2fe;
    }

    .history.visible {
      display: block;
    }

    .history ul {
      padding-left: 1.1rem;
      margin: 0.25rem 0 0;
    }

    .history li {
      margin-bottom: 0.15rem;
    }

    .empty-text {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .obra-details {
      margin-top: 0.5rem;
      display: none;
    }

    .obra-details.visible {
      display: block;
    }

    .card-obra {
      border-left-width: 6px;
    }

    .title-box {
      padding: 0.6rem 0.85rem;
      border-radius: 14px;
      background: #f9fafb;
    }

    .title-box .card-header-title {
      margin-bottom: 0.15rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.2rem;
    }

    .obra-header-right {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      align-items: flex-end;
      font-size: 0.82rem;
    }

    #obraMap {
      height: 260px;
      border-radius: 14px;
      margin-top: 0.45rem;
      border: 1px solid #d1d5db;
      overflow: hidden;
    }

    /* üì± Mejora fuerte para m√≥vil / tablet */
    @media (max-width: 900px) {
      body {
        padding: 0.75rem;
      }

      .app-shell {
        max-width: 100%;
      }

      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      header.app-header h1 {
        font-size: 1.6rem;
      }

      header.app-header p {
        font-size: 0.9rem;
      }

      .card {
        padding: 0.9rem 0.9rem 1.1rem;
        border-radius: 16px;
      }

      .form-row {
        grid-template-columns: minmax(0, 1fr);
      }

      input[type="text"],
      select {
        font-size: 1rem;
        padding: 0.7rem 0.85rem;
      }

      button {
        font-size: 0.95rem;
        padding: 0.65rem 1rem;
      }

      .worker-main {
        flex-direction: column;
        align-items: flex-start;
      }

      .worker-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .worker-actions button {
        flex: 1 1 45%;
        min-width: 140px;
      }

      #obraMap {
        height: 230px;
      }
    }

    @media (max-width: 600px) {
      header.app-header h1 {
        font-size: 1.45rem;
      }
      button.primary {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <h1>
        <span class="logo-badge">BRB</span>
        Fichaje de obras
      </h1>
      <p>Gestiona obras y fichajes de trabajadores desde m√≥vil, tablet o PC.</p>
    </header>

    <div class="layout-grid">
      <!-- Columna izquierda: nueva obra -->
      <section class="card">
        <div class="card-title">
          <h2>Nueva obra</h2>
          <span>Alta r√°pida de obra</span>
        </div>

        <div class="form-row">
          <div>
            <label for="obraTitulo">T√≠tulo de la obra</label>
            <input type="text" id="obraTitulo" placeholder="Reforma edificio Calle Mayor 12" />
          </div>
          <div>
            <label for="obraLugar">Lugar (descripci√≥n)</label>
            <input type="text" id="obraLugar" placeholder="Las Palmas de Gran Canaria" />
          </div>
        </div>

        <div class="obra-meta">
          <span class="chip">BRB Construcciones</span>
          <div style="min-width: 140px;">
            <label for="obraTipoEmpresa">Tipo de empresa</label>
            <select id="obraTipoEmpresa">
              <option value="SL">SL</option>
              <option value="Aut√≥nomo">Aut√≥nomo</option>
            </select>
          </div>
        </div>

        <div>
          <label>Ubicaci√≥n en mapa (opcional)</label>
          <div id="obraMap"></div>
          <p id="obraCoordsText" class="small-text" style="margin-top:0.3rem;">
            Toca el mapa para guardar coordenadas de la obra.
          </p>
        </div>

        <button id="btnAddObra" class="primary">A√±adir obra</button>
        <p id="obraError" class="small-text" style="color:#ef4444; margin-top:0.5rem; display:none;">
          Rellena al menos el t√≠tulo y el lugar.
        </p>
      </section>

      <!-- Columna derecha: listado de obras -->
      <section class="card">
        <div class="card-title">
          <h2>Obras y trabajadores</h2>
          <span>Gestiona fichajes y exporta historiales</span>
        </div>
        <div id="obrasContainer"></div>
      </section>
    </div>
  </div>

  <!-- Leaflet JS para el mapa -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- APP + FIREBASE en un script tipo m√≥dulo -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCoaW8FFNghoXmCuoyZJSHWLEFN5mlJJU",
      authDomain: "fichaje-brb-c9385.firebaseapp.com",
      projectId: "fichaje-brb-c9385",
      storageBucket: "fichaje-brb-c9385.firebasestorage.app",
      messagingSenderId: "695373590746",
      appId: "1:695373590746:web:8dd206b125b3119c7cf5e3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "app", "data"); // Documento √∫nico

    const state = { obras: [] };

    const obraColors = [
      "#22c55e",
      "#3b82f6",
      "#6366f1",
      "#f97316",
      "#ec4899",
      "#0ea5e9"
    ];

    let obraMap = null;
    let obraMarker = null;
    let newObraCoords = null;

    function createId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    async function saveToCloud() {
      await setDoc(dataDocRef, { obras: state.obras });
    }

    function setupMap() {
      const mapContainer = document.getElementById("obraMap");
      if (!mapContainer) return;

      obraMap = L.map("obraMap").setView([27.919, -15.409], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(obraMap);

      const coordsText = document.getElementById("obraCoordsText");

      obraMap.on("click", (e) => {
        newObraCoords = e.latlng;

        if (obraMarker) {
          obraMarker.setLatLng(e.latlng);
        } else {
          obraMarker = L.marker(e.latlng).addTo(obraMap);
        }

        coordsText.textContent =
          "Coordenadas seleccionadas: " +
          e.latlng.lat.toFixed(5) +
          ", " +
          e.latlng.lng.toFixed(5);
      });
    }

    function setupAddObraForm() {
      const tituloInput = document.getElementById("obraTitulo");
      const lugarInput = document.getElementById("obraLugar");
      const tipoSelect = document.getElementById("obraTipoEmpresa");
      const addButton = document.getElementById("btnAddObra");
      const errorMsg = document.getElementById("obraError");
      const coordsText = document.getElementById("obraCoordsText");

      addButton.addEventListener("click", async () => {
        const titulo = tituloInput.value.trim();
        const lugar = lugarInput.value.trim();
        const tipo = tipoSelect.value;

        if (!titulo || !lugar) {
          errorMsg.style.display = "block";
          return;
        }
        errorMsg.style.display = "none";

        const nuevaObra = {
          id: createId(),
          titulo,
          lugar,
          empresaNombre: "BRB Construcciones",
          empresaTipo: tipo,
          trabajadores: [],
          expanded: false,
          coords: newObraCoords
            ? { lat: newObraCoords.lat, lng: newObraCoords.lng }
            : null
        };

        state.obras.push(nuevaObra);
        await saveToCloud();

        tituloInput.value = "";
        lugarInput.value = "";
        tipoSelect.value = "SL";

        newObraCoords = null;
        if (obraMarker && obraMap) {
          obraMap.removeLayer(obraMarker);
          obraMarker = null;
        }
        coordsText.textContent = "Toca el mapa para guardar coordenadas de la obra.";
      });
    }

    function renderObras() {
      const container = document.getElementById("obrasContainer");
      container.innerHTML = "";

      if (state.obras.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-text";
        p.textContent = "Todav√≠a no hay obras creadas.";
        container.appendChild(p);
        return;
      }

      state.obras.forEach((obra, index) => {
        const card = document.createElement("div");
        card.className = "card card-obra";

        const color = obraColors[index % obraColors.length];
        card.style.borderLeftColor = color;

        const header = document.createElement("div");
        header.className = "card-header";

        const titleBox = document.createElement("div");
        titleBox.className = "title-box";
        titleBox.style.backgroundColor = color + "15";
        titleBox.style.borderColor = color + "55";

        const title = document.createElement("div");
        title.className = "card-header-title";
        title.textContent = obra.titulo;

        const subtitle = document.createElement("div");
        subtitle.className = "small-text";
        subtitle.textContent = obra.lugar;

        if (obra.coords) {
          const coordsLine = document.createElement("div");
          coordsLine.className = "small-text";
          coordsLine.textContent =
            "Coordenadas: " +
            obra.coords.lat.toFixed(5) +
            ", " +
            obra.coords.lng.toFixed(5);
          subtitle.appendChild(document.createElement("br"));
          subtitle.appendChild(coordsLine);
        }

        titleBox.appendChild(title);
        titleBox.appendChild(subtitle);

        const empresaDiv = document.createElement("div");
        empresaDiv.className = "small-text";
        empresaDiv.innerHTML =
          "<strong>" +
          obra.empresaNombre +
          "</strong> ¬∑ " +
          obra.empresaTipo;

        const deleteObraBtn = document.createElement("button");
        deleteObraBtn.className = "danger";
        deleteObraBtn.textContent = "Eliminar obra";

        deleteObraBtn.addEventListener("click", async () => {
          const seguro = confirm(
            "¬øSeguro que quieres eliminar esta obra y todos sus trabajadores y fichajes?"
          );
          if (!seguro) return;

          state.obras = state.obras.filter((o) => o.id !== obra.id);
          await saveToCloud();
        });

        const rightSide = document.createElement("div");
        rightSide.className = "obra-header-right";
        rightSide.appendChild(empresaDiv);
        rightSide.appendChild(deleteObraBtn);

        header.appendChild(titleBox);
        header.appendChild(rightSide);

        card.appendChild(header);

        const details = document.createElement("div");
        details.className = "obra-details";
        if (obra.expanded) {
          details.classList.add("visible");
        }

        const formTrab = document.createElement("div");
        formTrab.className = "form-row";

        const nombreWrapper = document.createElement("div");
        const nombreLabel = document.createElement("label");
        nombreLabel.textContent = "Nombre";
        const nombreInput = document.createElement("input");
        nombreInput.type = "text";
        nombreInput.placeholder = "Nombre";
        nombreWrapper.appendChild(nombreLabel);
        nombreWrapper.appendChild(nombreInput);

        const apellidosWrapper = document.createElement("div");
        const apellidosLabel = document.createElement("label");
        apellidosLabel.textContent = "Apellidos";
        const apellidosInput = document.createElement("input");
        apellidosInput.type = "text";
        apellidosInput.placeholder = "Apellidos";
        apellidosWrapper.appendChild(apellidosLabel);
        apellidosWrapper.appendChild(apellidosInput);

        const dniWrapper = document.createElement("div");
        const dniLabel = document.createElement("label");
        dniLabel.textContent = "DNI";
        const dniInput = document.createElement("input");
        dniInput.type = "text";
        dniInput.placeholder = "00000000X";
        dniWrapper.appendChild(dniLabel);
        dniWrapper.appendChild(dniInput);

        formTrab.appendChild(nombreWrapper);
        formTrab.appendChild(apellidosWrapper);
        formTrab.appendChild(dniWrapper);

        const addTrabBtn = document.createElement("button");
        addTrabBtn.textContent = "A√±adir trabajador";
        addTrabBtn.className = "secondary";

        const errorTrab = document.createElement("p");
        errorTrab.className = "small-text";
        errorTrab.style.color = "#ef4444";
        errorTrab.style.display = "none";
        errorTrab.style.marginTop = "0.3rem";
        errorTrab.textContent =
          "Nombre, apellidos y DNI son obligatorios.";

        const workersContainer = document.createElement("div");
        workersContainer.className = "workers-list";

        if (!Array.isArray(obra.trabajadores)) {
          obra.trabajadores = [];
        }

        if (obra.trabajadores.length === 0) {
          const empty = document.createElement("p");
          empty.className = "empty-text";
          empty.textContent = "No hay trabajadores a√±adidos a√∫n.";
          workersContainer.appendChild(empty);
        } else {
          obra.trabajadores.forEach((trabajador) => {
            const workerEl = createWorkerElement(obra, trabajador);
            workersContainer.appendChild(workerEl);
          });
        }

        details.appendChild(formTrab);
        details.appendChild(addTrabBtn);
        details.appendChild(errorTrab);
        details.appendChild(workersContainer);

        card.appendChild(details);

        addTrabBtn.addEventListener("click", async () => {
          const nombre = nombreInput.value.trim();
          const apellidos = apellidosInput.value.trim();
          const dni = dniInput.value.trim();

          if (!nombre || !apellidos || !dni) {
            errorTrab.style.display = "block";
            return;
          }
          errorTrab.style.display = "none";

          const nuevoTrab = {
            id: createId(),
            nombre,
            apellidos,
            dni,
            fichajes: []
          };

          const emptyMsg = workersContainer.querySelector(".empty-text");
          if (emptyMsg) {
            workersContainer.removeChild(emptyMsg);
          }

          obra.trabajadores.push(nuevoTrab);
          await saveToCloud();
        });

        titleBox.addEventListener("click", async () => {
          const wasExpanded = !!obra.expanded;
          state.obras.forEach((o) => {
            o.expanded = false;
          });
          obra.expanded = !wasExpanded;
          await saveToCloud();
        });

        container.appendChild(card);
      });
    }

    function createWorkerElement(obra, trabajador) {
      const workerItem = document.createElement("div");
      workerItem.className = "worker-item";

      const main = document.createElement("div");
      main.className = "worker-main";

      const info = document.createElement("div");
      info.className = "worker-info";

      const name = document.createElement("div");
      name.className = "worker-name";
      name.textContent = trabajador.nombre + " " + trabajador.apellidos;

      const dni = document.createElement("div");
      dni.className = "worker-dni";
      dni.textContent = "DNI: " + trabajador.dni;

      info.appendChild(name);
      info.appendChild(dni);

      const actions = document.createElement("div");
      actions.className = "worker-actions";

      const ficharBtn = document.createElement("button");
      ficharBtn.className = "primary";
      ficharBtn.textContent = "Fichar";

      const exportBtn = document.createElement("button");
      exportBtn.className = "secondary";
      exportBtn.textContent = "Exportar historial (Word)";

      const historyToggle = document.createElement("button");
      historyToggle.className = "secondary";
      historyToggle.textContent = "Ver historial";

      const deleteWorkerBtn = document.createElement("button");
      deleteWorkerBtn.className = "danger";
      deleteWorkerBtn.textContent = "Eliminar trabajador";

      actions.appendChild(ficharBtn);
      actions.appendChild(exportBtn);
      actions.appendChild(historyToggle);
      actions.appendChild(deleteWorkerBtn);

      main.appendChild(info);
      main.appendChild(actions);

      workerItem.appendChild(main);

      const history = document.createElement("div");
      history.className = "history";
      workerItem.appendChild(history);

      function renderHistory() {
        history.innerHTML = "";
        const title = document.createElement("div");
        title.textContent = "Historial de fichajes:";
        history.appendChild(title);

        if (!Array.isArray(trabajador.fichajes) || trabajador.fichajes.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty-text";
          empty.textContent = "Este trabajador a√∫n no ha fichado.";
          history.appendChild(empty);
          return;
        }

        const list = document.createElement("ul");
        const sorted = trabajador.fichajes
          .slice()
          .sort((a, b) => b - a);

        sorted.forEach((ts, idx) => {
          const li = document.createElement("li");
          const fecha = new Date(ts);
          li.textContent =
            (idx + 1) + ". " + fecha.toLocaleString("es-ES");
          list.appendChild(li);
        });

        history.appendChild(list);
      }

      renderHistory();

      ficharBtn.addEventListener("click", async () => {
        const now = Date.now();
        if (!Array.isArray(trabajador.fichajes)) {
          trabajador.fichajes = [];
        }
        trabajador.fichajes.push(now);

        await saveToCloud();

        if (history.classList.contains("visible")) {
          renderHistory();
        }
      });

      historyToggle.addEventListener("click", () => {
        const visible = history.classList.toggle("visible");
        if (visible) {
          renderHistory();
          historyToggle.textContent = "Ocultar historial";
        } else {
          historyToggle.textContent = "Ver historial";
        }
      });

      deleteWorkerBtn.addEventListener("click", async () => {
        const seguro = confirm(
          "¬øEliminar al trabajador " +
            trabajador.nombre +
            " " +
            trabajador.apellidos +
            " y todos sus fichajes?"
        );
        if (!seguro) return;

        obra.trabajadores = obra.trabajadores.filter(
          (t) => t.id !== trabajador.id
        );
        await saveToCloud();
      });

      exportBtn.addEventListener("click", () => {
        if (!Array.isArray(trabajador.fichajes) || trabajador.fichajes.length === 0) {
          alert("Este trabajador a√∫n no tiene fichajes para exportar.");
          return;
        }

        const sorted = trabajador.fichajes
          .slice()
          .sort((a, b) => a - b);

        let rows = "";
        sorted.forEach((ts, index) => {
          const fecha = new Date(ts).toLocaleString("es-ES");
          rows +=
            "<tr><td>" +
            (index + 1) +
            "</td><td>" +
            fecha +
            "</td></tr>";
        });

        const html =
          "<html><head><meta charset='utf-8'><title>Historial de fichajes</title></head><body>" +
          "<h2>Historial de fichajes</h2>" +
          "<p><b>Obra:</b> " +
          obra.titulo +
          " (" +
          obra.lugar +
          ")</p>" +
          "<p><b>Empresa:</b> " +
          obra.empresaNombre +
          " ¬∑ " +
          obra.empresaTipo +
          "</p>" +
          "<p><b>Trabajador:</b> " +
          trabajador.nombre +
          " " +
          trabajador.apellidos +
          "</p>" +
          "<p><b>DNI:</b> " +
          trabajador.dni +
          "</p><br/>" +
          "<table border='1' cellpadding='4' cellspacing='0'>" +
          "<tr><th>#</th><th>Fecha y hora de fichaje</th></tr>" +
          rows +
          "</table></body></html>";

        const blob = new Blob(["\ufeff", html], {
          type: "application/msword"
        });
        const url = URL.createObjectURL(blob);

        const apellidoLimpio = trabajador.apellidos.replace(/\s+/g, "_");
        const nombreLimpio = trabajador.nombre.replace(/\s+/g, "_");
        const a = document.createElement("a");
        a.href = url;
        a.download = "historial_" + apellidoLimpio + "_" + nombreLimpio + ".doc";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      return workerItem;
    }

    function subscribeToCloud() {
      onSnapshot(
        dataDocRef,
        async (snap) => {
          if (!snap.exists()) {
            await setDoc(dataDocRef, { obras: [] });
            return;
          }
          const data = snap.data() || {};
          state.obras = Array.isArray(data.obras) ? data.obras : [];
          renderObras();
        },
        (err) => {
          console.error("Error escuchando Firestore:", err);
          alert("Error escuchando datos de la nube: " + err.message);
        }
      );
    }

    window.addEventListener("DOMContentLoaded", () => {
      setupAddObraForm();
      setupMap();
      subscribeToCloud();
    });
  </script>

  <!-- Registro del Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .then(() => console.log("Service Worker registrado"))
          .catch((err) => console.error("Error registrando Service Worker", err));
      });
    }
  </script>
</body>
</html>
